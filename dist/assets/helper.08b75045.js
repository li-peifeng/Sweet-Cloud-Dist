import{an as _,d as B,aP as C,b2 as b,j as m,c as t,al as M,c4 as J,bG as Y,S as w,ar as Z,c8 as Ge,c9 as Ne,a_ as R,bH as me,c$ as we,B as x,b3 as A,n as Q,x as k,Z as O,cT as je,d1 as T,z as fe,d2 as He,c6 as $e,o as Ve,k as We,t as Ue,y as D,ck as Ke,cc as Xe,aD as j,cf as ke,d3 as xe,d4 as ye,as as ee}from"./index.fd01cb2f.js";import{P as Ze}from"./Paginator.881c3028.js";const qe={[7]:"danger",[2]:"success",[4]:"neutral"},Je=e=>{if(e.role<0)return null;const n=["info","neutral","accent"];return t($e,{get colorScheme(){return n[e.role]},css:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},get children(){return e.name}})},Qe=e=>{const n=B();return t($e,{get colorScheme(){var s;return(s=qe[e.state])!=null?s:"info"},get children(){return n(`tasks.state.${e.state}`)}})},l=[{name:"name",textAlign:"left",w:_().role===2?"calc(100% - 660px)":"calc(100% - 560px)"},{name:"creator",textAlign:"center",w:_().role===2?"100px":"0"},{name:"state",textAlign:"center",w:"100px"},{name:"progress",textAlign:"left",w:"140px"},{name:"speed",textAlign:"center",w:"100px"},{name:"operation",textAlign:"right",w:"220px"}],q=e=>Math.floor(e).toString().padStart(2,"0"),Ye=e=>{const n=e/1e3%60,s=e/1e3/60%60,i=e/1e3/3600;return`${q(i)}:${q(s)}:${q(n)}`},et=e=>{const n=B(),s=e.done==="undone"?"cancel":"delete",i=e.done==="done"&&e.state===7,[d,u]=C(()=>b.post(`/task/${e.type}/${s}?tid=${e.id}`)),[y,g]=C(()=>b.post(`/task/${e.type}/retry?tid=${e.id}`)),[f,F]=m(!1),v=e.name.match(e.nameAnalyzer.regex),H=v===null?e.name:e.nameAnalyzer.title(v),h=e.start_time===null?-1:new Date(e.start_time).getTime(),E=e.end_time===null?new Date().getTime():new Date(e.end_time).getTime();let I="-";const G=(o,z)=>{let S=z/o,P="bytes/s";return S>1024&&(S/=1024,P="KB/s"),S>1024&&(S/=1024,P="MB/s"),S>1024&&(S/=1024,P="GB/s"),`${S.toFixed(2)} ${P}`};if(e.done){if(e.start_time!==e.end_time&&e.progress>0&&h!==-1){const o=(E-h)/1e3,z=e.total_bytes*e.progress/100;I=G(o,z)}}else if(e.prevProgress!==void 0&&e.prevFetchTime!==void 0){const o=(e.curFetchTime-e.prevFetchTime)/1e3,z=(e.progress-e.prevProgress)*e.total_bytes/100;I=G(o,z)}return t(w,{get when(){return!f()},get children(){return[t(M,{w:"$full",p:"$2",get children(){return[t(M,{get w(){return l[0].w},spacing:"$1",get children(){return[t(J,{"on:click":o=>{o.stopPropagation()},get checked(){return e.local.selected},onChange:o=>{e.setLocal({selected:o.target.checked,expanded:e.local.expanded})}}),t(Y,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:H})]}}),t(w,{get when(){return _().role===2},get children(){return t(Z,{get w(){return l[1].w},get children(){return t(Je,{get name(){return e.creator},get role(){return e.creator_role}})}})}}),t(Z,{get w(){return l[2].w},get children(){return t(Qe,{get state(){return e.state}})}}),t(Ge,{get w(){return l[3].w},trackColor:"$info3",rounded:"$full",size:"sm",get value(){return e.progress},mr:"$1",get children(){return t(Ne,{color:"$info8",rounded:"$md"})}}),t(Z,{get w(){return l[1].w},get children(){return t(R,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:I})}}),t(me,{get w(){return l[5].w},gap:"$1",get children(){return[t(we,{}),t(w,{get when(){return e.canRetry},get children(){return t(x,{size:"sm",disabled:!i,display:i?"block":"none",get loading(){return y()},onClick:async()=>{const o=await g();A(o,()=>{Q.info(n("tasks.retry")),F(!0)})},get children(){return n("tasks.retry")}})}}),t(x,{size:"sm",colorScheme:"danger",get loading(){return d()},onClick:async()=>{const o=await u();A(o,()=>{Q.success(n("global.delete_success")),F(!0)})},get children(){return n(`global.${s}`)}}),t(x,{size:"sm",colorScheme:"neutral",onClick:()=>{e.setLocal({selected:e.local.selected,expanded:!e.local.expanded})},get children(){return k(()=>!!e.local.expanded)()?n("tasks.fold"):n("tasks.expand")}})]}})]}}),t(w,{get when(){return e.local.expanded},get children(){return t(O,{css:{wordBreak:"break-all",fontSize:"0.8em"},w:"$full",pl:"$2",pr:"$2",get children(){return[t(je,{templateColumns:"min-content 1fr",w:"$full",columnGap:"$4",mb:"$2",get children(){return[t(w,{when:h!==-1,get children(){return[t(T,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.time_elapsed")}}),t(T,{color:"$neutral9",get children(){return Ye(E-h)}})]}}),t(w,{when:v!==null,get children(){return t(fe,{get each(){return Object.entries(e.nameAnalyzer.attrs)},children:o=>[t(T,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return o[0]}}),t(T,{color:"$neutral9",get children(){return o[1](v)}})]})}}),t(T,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.status")}}),t(T,{color:"$neutral9",get children(){return e.status}}),t(w,{get when(){return e.error},get children(){return[t(T,{color:"$danger9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.err")}}),t(T,{color:"$danger9",get children(){return e.error}})]}})]}}),t(He,{})]}})}})]}})},tt=e=>{const n=B(),[s,i]=C(()=>b.get(`/task/${e.type}/${e.done}`)),[d,u]=m([]),[y,g]=m("name"),[f,F]=m(!1),v={name:(r,a)=>r.name>a.name?1:-1,creator:(r,a)=>r.creator===a.creator?r.id>a.id?1:-1:r.creator>a.creator?1:-1,state:(r,a)=>r.state===a.state?r.id>a.id?1:-1:r.state>a.state?1:-1,progress:(r,a)=>r.progress===a.progress?r.id>a.id?1:-1:r.progress<a.progress?1:-1},H=k(()=>(r,a)=>(f()?-1:1)*v[y()](r,a)),h=async()=>{const r=await i();A(r,a=>{var ue;const $=new Date().getTime(),oe={},ie={},U={},de={},ge={};for(const c of d())oe[c.id]=c.curFetchTime,ie[c.id]=c.prevFetchTime,U[c.id]=c.progress,de[c.id]=c.prevProgress,ge[c.id]=c.local;u((ue=a==null?void 0:a.map(c=>{var he;let K,X;c.progress===U[c.id]?(K=ie[c.id],X=de[c.id]):(K=oe[c.id],X=U[c.id]);const Ee=(he=ge[c.id])!=null?he:{selected:!1,expanded:!1};return{...c,curFetchTime:$,prevFetchTime:K,prevProgress:X,local:Ee}}).sort(H()))!=null?ue:[])})};if(h(),e.done==="undone"){const r=setInterval(h,2e3);Ve(()=>clearInterval(r))}const[E,I]=C(()=>b.post(`/task/${e.type}/clear_done`)),[G,o]=C(()=>b.post(`/task/${e.type}/clear_succeeded`)),[z,S]=C(()=>b.post(`/task/${e.type}/retry_failed`)),[P,_e]=m(""),[pe,Te]=m(new RegExp("")),[Ce,te]=m(!1);We(()=>{try{Te(new RegExp(P())),te(!1)}catch(r){te(!0)}});const[re,be]=m(_().role!==2),V=k(()=>{const r=pe(),a=re();return $=>r.test($.name)&&(!a||$.creator===_().username)}),p=k(()=>d().filter(V())),ne=k(()=>p().map(r=>r.local.selected).every(Boolean)),Ae=k(()=>p().map(r=>r.local.selected).some(Boolean)&&!ne()),Fe=r=>u(d().map(a=>(V()(a)&&(a.local.selected=r),a))),ae=k(()=>p().map(r=>r.local.expanded).every(Boolean)),ze=r=>u(d().map(a=>(V()(a)&&(a.local.expanded=r),a))),le=()=>p().filter(r=>r.local.selected).map(r=>r.id),[Pe,De]=C(()=>b.post(`/task/${e.type}/retry_some`,le())),[Re,Le]=C(()=>b.post(`/task/${e.type}/${ce}_some`,le())),se=r=>{Object.entries(r).forEach(([a,$])=>{Q.error(`${a}: ${$}`)})},[Be,Ie]=m(1),W=20,ce=e.done==="undone"?"cancel":"delete",Me=k(()=>{const r=(Be()-1)*W,a=r+W;return p().slice(r,a)}),L=r=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:r.textAlign}),N=r=>({cursor:"pointer",onClick:()=>{y()===r.name?F(!f()):Ke(()=>{g(r.name),F(!1)}),h()}}),Oe=r=>a=>u(d().map($=>($.id===r&&($.local=a),$)));return t(O,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[t(Y,{size:"lg",get children(){return n(`tasks.${e.done}`)}}),t(M,{gap:"$2",flexWrap:"wrap",get children(){return[t(w,{get when(){return e.done==="done"},get children(){return[t(x,{colorScheme:"accent",get loading(){return s()},onClick:h,get children(){return n("global.refresh")}}),t(x,{get loading(){return z()},onClick:async()=>{const r=await S();A(r,()=>h())},get children(){return n("tasks.retry_failed")}}),t(x,{colorScheme:"danger",get loading(){return E()},onClick:async()=>{const r=await I();A(r,()=>h())},get children(){return n("global.clear")}}),t(x,{colorScheme:"success",get loading(){return G()},onClick:async()=>{const r=await o();A(r,()=>h())},get children(){return n("tasks.clear_succeeded")}})]}}),t(w,{get when(){return e.canRetry},get children(){return t(x,{colorScheme:"primary",get loading(){return Pe()},onClick:async()=>{const r=await De();A(r,a=>{se(a),h()})},get children(){return n("tasks.retry_selected")}})}}),t(x,{colorScheme:"warning",get loading(){return Re()},onClick:async()=>{const r=await Le();A(r,a=>{se(a),h()})},get children(){return n(`tasks.${ce}_selected`)}}),t(Ue,{width:"auto",get placeholder(){return n("tasks.filter")},get value(){return P()},onInput:r=>_e(r.target.value),get invalid(){return Ce()}}),t(w,{get when(){return _().role===2},get children(){return t(J,{get checked(){return re()},onChange:r=>be(r.target.checked),get children(){return n("tasks.show_only_mine")}})}})]}}),t(O,{w:{"@initial":"1024px","@lg":"$full"},overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[t(M,{class:"title",w:"$full",p:"$2",get children(){return[t(M,{get w(){return l[0].w},spacing:"$1",get children(){return[t(J,{get disabled(){return p().length===0},get checked(){return ne()},get indeterminate(){return Ae()},onChange:r=>Fe(r.target.checked)}),t(R,D(()=>L(l[0]),()=>N(l[0]),{get children(){return n(`tasks.attr.${l[0].name}`)}}))]}}),t(w,{get when(){return _().role===2},get children(){return t(R,D({get w(){return l[1].w}},()=>L(l[1]),()=>N(l[1]),{get children(){return n(`tasks.attr.${l[1].name}`)}}))}}),t(R,D({get w(){return l[2].w}},()=>L(l[2]),()=>N(l[2]),{get children(){return n(`tasks.attr.${l[2].name}`)}})),t(R,D({get w(){return l[3].w}},()=>L(l[3]),()=>N(l[3]),{get children(){return n(`tasks.attr.${l[3].name}`)}})),t(R,D({get w(){return l[4].w}},()=>L(l[4]),{get children(){return n(`tasks.attr.${l[4].name}`)}})),t(me,{get w(){return l[5].w},gap:"$2",get children(){return[t(we,{}),t(R,D(()=>L(l[5]),{get children(){return n(`tasks.attr.${l[5].name}`)}})),t(x,{size:"xs",colorScheme:"neutral",onClick:()=>ze(!ae()),get disabled(){return p().length===0},get children(){return k(()=>!!ae())()?n("tasks.fold_all"):n("tasks.expand_all")}})]}})]}}),k(()=>Me().map(r=>t(et,D(r,e,{get setLocal(){return Oe(r.id)}}))))]}}),t(Ze,{get total(){return p().length},defaultPageSize:W,onChange:r=>{Ie(r)}})]}})},st=e=>{const n=B();return t(O,{w:"$full",alignItems:"start",spacing:"$4",get children(){return[t(Y,{size:"xl",get children(){return n(`tasks.${e.type}`)}}),t(O,{w:"$full",spacing:"$2",get children(){return t(fe,{each:["undone","done"],children:s=>t(tt,{get type(){return e.type},done:s,get canRetry(){return e.canRetry},get nameAnalyzer(){return e.nameAnalyzer}})})}})]}})};var rt=ee("<a>"),ve=ee("<p>"),nt=ee("<a target=_blank>");const Se=(e,n)=>{const s=(e==="/"?"":e)+n,i=_().base_path==="/"?"":_().base_path,d=s.startsWith(i),[u,y]=m(!1);return d?(()=>{var g=rt();return g.$$mouseout=()=>y(!1),g.$$mouseover=()=>y(!0),j(g,s),ke(f=>{var F=u()?"text-decoration: underline":"",v=s.slice(i.length);return f.e=xe(g,F,f.e),v!==f.t&&ye(g,"href",f.t=v),f},{e:void 0,t:void 0}),g})():(()=>{var g=ve();return j(g,s),g})()},ct=()=>{const e=B(),[n,s]=m(!1);return{regex:/^download (.+) to \((.+)\)$/,title:i=>i[1],attrs:{[e("tasks.attr.offline_download.url")]:i=>(()=>{var d=nt();return d.$$mouseout=()=>s(!1),d.$$mouseover=()=>s(!0),j(d,()=>i[1]),ke(u=>{var y=n()?"text-decoration: underline":"",g=i[1];return u.e=xe(d,y,u.e),g!==u.t&&ye(d,"href",u.t=g),u},{e:void 0,t:void 0}),d})(),[e("tasks.attr.offline_download.path")]:i=>Se("",i[2])}}},ot=()=>{const e=B();return{regex:/^transfer ((?:.*\/)?(.+)) to \[(.+)]$/,title:n=>n[2],attrs:{[e("tasks.attr.offline_download.transfer_src")]:n=>(()=>{var s=ve();return j(s,()=>n[1]),s})(),[e("tasks.attr.offline_download.transfer_dst")]:n=>Se("",n[3])}}};Xe(["mouseover","mouseout"]);export{st as T,ot as a,Se as b,ct as g};
