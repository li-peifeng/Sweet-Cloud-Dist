import{bR as ee,aC as _,R as $,b as j,bN as d,bS as w,d as te,e,az as A,b4 as f,bT as ne,bU as re,W as F,a as oe,j as se,k as g,bV as ae,aR as L,a3 as ie,bL as E,an as le,bK as ce,S as h,I as T,bW as B,b0 as ue,a8 as ge,B as U,as as de,bB as N,n as m,b5 as pe}from"./index.d9e98605.js";import{k as he,v as me,w as fe,d as we,x as be}from"./index.f1c4c1df.js";import{s as Se,g as ke,a as $e}from"./webauthn-json.browser-ponyfill.1c672167.js";const _e="https://github.com/alist-org/alist";function Ie(l){return ee(`${l}-${_e}`)}const Ce=()=>{const l=_("sso_login_enabled"),I=$("sso_login_platform"),n=_("sso_compatibility_mode"),{searchParams:c,to:b}=j(),o=c.token;o!=null&&o!=""&&(d(o),b(decodeURIComponent(c.redirect||w||"/"),!0));function p(s){const r=s.data;r.token&&(d(r.token),b(decodeURIComponent(c.redirect||w||"/"),!0))}if(window.addEventListener("message",p),te(()=>{window.removeEventListener("message",p)}),l){const s=()=>{const u=f.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=u;return}window.open(u,"authPopup","width=500,height=600")};let r;switch(I){case"Github":r=fe;break;case"Microsoft":r=me;break;case"Google":r=re;break;case"Dingtalk":r=ne;break;default:r=he}return e(A,{cursor:"pointer",boxSize:"$8",as:r,p:"$0_5",onclick:s})}},Re=()=>{const l=$("logo").split(`
`),I=F(l[0],l.pop()),n=oe(),c=se(()=>`${$("site_title")}`);we(c);const b=F("white","$neutral1"),[o,p]=g(localStorage.getItem("username")||""),[s,r]=g(localStorage.getItem("password")||""),[u,O]=g(""),[S,D]=g(!1),[k,G]=ae("remember-pwd","false"),[C,z]=g(!1),[M,K]=L(async()=>C()?f.post("/auth/login/ldap",{username:o(),password:s(),otp_code:u()}):f.post("/auth/login/hash",{username:o(),password:Ie(s()),otp_code:u()})),[,V]=L((t,a,i)=>f.post("/authn/webauthn_finish_login?username="+i,JSON.stringify(a),{headers:{session:t}})),[,W]=L(t=>f.get("/authn/webauthn_begin_login?username="+t)),{searchParams:y,to:v}=j(),H=_("webauthn_login_enabled"),J=async()=>{D(!S())},x=async()=>{if(S()){if(!Se()){m.error(n("users.webauthn_not_supported"));return}d(),k()==="true"?localStorage.setItem("username",o()):localStorage.removeItem("username");const t=await W(o());pe(t,async a=>{try{const i=ke(a.options),X=await $e(i),Y=await V(a.session,X,o());N(Y,Z=>{m.success(n("login.success")),d(Z.token),v(decodeURIComponent(y.redirect||w||"/"),!0)})}catch(i){i instanceof Error&&m.error(i.message)}})}else{k()==="true"?(localStorage.setItem("username",o()),localStorage.setItem("password",s())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await K();N(t,a=>{m.success(n("login.success")),d(a.token),v(decodeURIComponent(y.redirect||w||"/"),!0)},(a,i)=>{!R()&&i===402?q(!0):m.error(a)})}},[R,q]=g(!1),P=_("ldap_login_enabled"),Q=$("ldap_login_tips");return P&&z(!0),e(de,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(ie,{get bgColor(){return b()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(E,{alignItems:"center",justifyContent:"space-around",get children(){return[e(le,{mr:"$2",boxSize:"$12",get src(){return I()}}),e(ce,{color:"$info9",fontSize:"$2xl",get children(){return c()}})]}}),e(h,{get when(){return!R()},get fallback(){return e(T,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return u()},onInput:t=>O(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&x()}})},get children(){return[e(T,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return o()},onInput:t=>p(t.currentTarget.value)}),e(h,{get when(){return!S()},get children(){return e(T,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return s()},onInput:t=>r(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&x()}})}}),e(E,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(B,{get checked(){return k()==="true"},onChange:()=>G(k()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(ue,{get children(){return n("\u6E38\u5BA2\u767B\u5F55\u4E0D\u9700\u8981\u5BC6\u7801\u54E6")}})]}})]}}),e(ge,{w:"$full",spacing:"$2",get children(){return[e(h,{get when(){return!S()},get children(){return[e(U,{w:"$full",colorScheme:"danger",onClick:()=>{d(),v(decodeURIComponent(y.redirect||w||"/"),!0)},get children(){return n("login.use_guest")}}),e(U,{colorScheme:"warning",w:"$full",onClick:()=>{R()?O(""):(p(""),r(""))},get children(){return n("login.clear")}})]}}),e(U,{colorScheme:"success",w:"$full",get loading(){return M()},onClick:x,get children(){return n("login.login")}})]}}),e(h,{when:P,get children(){return e(B,{w:"$full",get checked(){return C()===!0},onChange:()=>z(!C()),children:Q})}}),e(E,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Ce,{}),e(h,{when:H,get children(){return e(A,{cursor:"pointer",boxSize:"$8",as:be,p:"$0_5",onclick:J})}})]}})]}})}})};export{Re as default};
