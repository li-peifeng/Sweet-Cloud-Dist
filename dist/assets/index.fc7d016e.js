import{c4 as ee,aI as _,X as k,e as N,b$ as d,c5 as w,j as te,c as e,I as j,b9 as f,c6 as ne,c7 as se,c8 as oe,a as D,d as re,q as ae,r as g,c9 as ie,aW as R,a6 as le,bO as E,av as ce,bN as ue,S as h,D as O,ca as F,b5 as ge,R as de,as as pe,G as T,ay as he,bE as G,n as m,ba as me}from"./index.cfab5714.js";import{c as fe,h as we,b as be,i as Se}from"./useTitle.0c1e5f6b.js";import{s as $e,g as ke,a as _e}from"./webauthn-json.browser-ponyfill.1c672167.js";const Ie="https://github.com/alist-org/alist";function ye(l){return ee(`${l}-${Ie}`)}const Ce=()=>{const l=_("sso_login_enabled"),I=k("sso_login_platform"),n=_("sso_compatibility_mode"),{searchParams:c,to:b}=N(),o=c.token;o!=null&&o!=""&&(d(o),b(decodeURIComponent(c.redirect||w||"/"),!0));function p(r){const s=r.data;s.token&&(d(s.token),b(decodeURIComponent(c.redirect||w||"/"),!0))}if(window.addEventListener("message",p),te(()=>{window.removeEventListener("message",p)}),l){const r=()=>{const u=f.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=u;return}window.open(u,"authPopup","width=500,height=600")};let s;switch(I){case"Github":s=we;break;case"Microsoft":s=oe;break;case"Google":s=se;break;case"Dingtalk":s=ne;break;default:s=fe}return e(j,{cursor:"pointer",boxSize:"$8",as:s,p:"$0_5",onclick:r})}},Re=()=>{const l=k("logo").split(`
`),I=D(l[0],l.pop()),n=re(),c=ae(()=>`${k("site_title")}`);be(c);const b=D("white","$neutral1"),[o,p]=g(localStorage.getItem("username")||""),[r,s]=g(localStorage.getItem("password")||""),[u,U]=g(""),[S,A]=g(!1),[$,B]=ie("remember-pwd","false"),[y,P]=g(!1),[M,q]=R(async()=>y()?f.post("/auth/login/ldap",{username:o(),password:r(),otp_code:u()}):f.post("/auth/login/hash",{username:o(),password:ye(r()),otp_code:u()})),[,H]=R((t,a,i)=>f.post("/authn/webauthn_finish_login?username="+i,JSON.stringify(a),{headers:{session:t}})),[,J]=R(t=>f.get("/authn/webauthn_begin_login?username="+t)),{searchParams:C,to:v}=N(),K=_("webauthn_login_enabled"),V=async()=>{A(!S())},x=async()=>{if(S()){if(!$e()){m.error(n("users.webauthn_not_supported"));return}d(),$()==="true"?localStorage.setItem("username",o()):localStorage.removeItem("username");const t=await J(o());me(t,async a=>{try{const i=ke(a.options),Q=await _e(i),Y=await H(a.session,Q,o());G(Y,Z=>{m.success(n("login.success")),d(Z.token),v(decodeURIComponent(C.redirect||w||"/"),!0)})}catch(i){i instanceof Error&&m.error(i.message)}})}else{$()==="true"?(localStorage.setItem("username",o()),localStorage.setItem("password",r())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await q();G(t,a=>{m.success(n("login.success")),d(a.token),v(decodeURIComponent(C.redirect||w||"/"),!0)},(a,i)=>{!L()&&i===402?W(!0):m.error(a)})}},[L,W]=g(!1),z=_("ldap_login_enabled"),X=k("ldap_login_tips");return z&&P(!0),e(he,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(le,{get bgColor(){return b()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(E,{alignItems:"center",justifyContent:"space-around",get children(){return[e(ce,{mr:"$2",boxSize:"$12",get src(){return I()}}),e(ue,{color:"$info9",fontSize:"$2xl",get children(){return c()}})]}}),e(h,{get when(){return!L()},get fallback(){return e(O,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return u()},onInput:t=>U(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&x()}})},get children(){return[e(O,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return o()},onInput:t=>p(t.currentTarget.value)}),e(h,{get when(){return!S()},get children(){return e(O,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return r()},onInput:t=>s(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&x()}})}}),e(E,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(F,{get checked(){return $()==="true"},onChange:()=>B($()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(ge,{color:"$info9",as:de,href:"https://peifeng.li/messages",children:"\u83B7\u53D6\u6388\u6743"})]}})]}}),e(pe,{w:"$full",spacing:"$2",get children(){return[e(h,{get when(){return!S()},get children(){return[e(T,{w:"$full",colorScheme:"danger",onClick:()=>{d(),v(decodeURIComponent(C.redirect||w||"/"),!0)},get children(){return n("login.use_guest")}}),e(T,{colorScheme:"warning",w:"$full",onClick:()=>{L()?U(""):(p(""),s(""))},get children(){return n("login.clear")}})]}}),e(T,{colorScheme:"success",w:"$full",get loading(){return M()},onClick:x,get children(){return n("login.login")}})]}}),e(h,{when:z,get children(){return e(F,{w:"$full",get checked(){return y()===!0},onChange:()=>P(!y()),children:X})}}),e(E,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Ce,{}),e(h,{when:K,get children(){return e(j,{cursor:"pointer",boxSize:"$8",as:Se,p:"$0_5",onclick:V})}})]}})]}})}})};export{Re as default};
